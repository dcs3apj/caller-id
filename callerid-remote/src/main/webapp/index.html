<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Who's calling?</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="Alex Jones">

<!-- Le styles -->
<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="css/custom.css" rel="stylesheet">
<link href="css/font-awesome.css" rel="stylesheet">

<link href="http://fonts.googleapis.com/css?family=Corben:bold"
	rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Nobile"
	rel="stylesheet" type="text/css">

<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->

<!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

<!-- Fav and touch icons 
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
      <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
                    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">
                                   <link rel="shortcut icon" href="../assets/ico/favicon.png">
  -->
</head>

<body>

	<div class="container">
		<header class="row">
			<h1 id="banner" class="span10">Who's Calling?</h1>
			<p class="span2">user</p>
		</header>
		<section class="row">
			<section class="span6" id="all-calls">
				<div id="carousel" data-interval="false" class="carousel slide">
					<div id="calls" class="carousel-inner"></div>
				</div>
                <div class="pagination pagination-right">
                    <ul id="nav"></ul>
                </div>
			</section>
			<section class="span6">
				<div id="map_canvas"></div>
			</section>
		</section>
		<footer class="row">
			<div class="span12">Footer</div>
		</footer>
	</div>


	<!-- Le javascript
    ================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script src="http://code.jquery.com/jquery.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/dust-full-1.2.2.js"></script>
	<script src="js/dust-helpers-1.1.1.js"></script>
	<script type="text/javascript"
		src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBPMGnJoq56NXDaFb21WdN_kkb585Q-qt4&amp;sensor=true"></script>

	<script type="text/javascript">
	    var map;
	    geocoder = new google.maps.Geocoder();
        var marker = new google.maps.Marker();
	    
		function loadDustResource(resourceName) {
			return $.ajax({
				url : "template/" + resourceName + ".dust",
				dataType : "text",
				success : function(resource) {
					dust.loadSource(dust.compile(resource, resourceName));
				}
			});
		}
		function createPage(pageNumber, calls) {
			var pageId = "page" + pageNumber;
            var navId = "nav" + pageNumber;
			dust.render("page", {
				id : pageId
			}, function(err, results) {
				$("#calls").append(results);
			});
            dust.render("nav", {
                id : navId,
                idx : pageNumber
            }, function(err, results) {
                $("#nav").append(results);
            });
			var page = $("#" + pageId)
            var nav = $("#" + navId)
			if (!pageNumber) {
				page.add(nav).addClass("active")
			}
			$.each(calls, function(idx, call) {
				dust.render("call", call, function(err, results) {
					page.append(results);
				})
			});
		}
		function loadCalls() {
			return $.ajax({
				url : "calls.json",
				dataType : "json",
				success : function(calls) {
					var page = 0;
					while (calls.length) {
						createPage(page++, calls.splice(0, 10));
					}
		            $("#carousel").bind('slid', function() { 
		                var index = $(this).find(".active").index(); 
		                $("#nav li").removeClass("active").eq(index).addClass("active"); 
		            });
		            $("#nav a").click(function(e) {
		                var page = parseInt($(this).attr("data-page")); 
                        $("#carousel").carousel("pause");
		                $("#carousel").carousel(page);
		            });
		            $("#calls button.contact").click(function(e) {
		            	var number = $(this).attr("data-number");
		            	alert("Contact: " + number);
		            });
                    $("#calls button.search").click(function(e) {
                        var searchTerm = $(this).attr("data-search-term");
                        alert("Search: " + searchTerm);
                    });
                    $("#calls button.map-marker").click(function(e) {
                        var countryCode = $(this).attr("data-country-code");
                        var location = $(this).attr("data-location");
                        geocoder.geocode( { address: location, region: countryCode }, function(results, status) {
                            if (status == google.maps.GeocoderStatus.OK) {
                              map.panTo(results[0].geometry.location);
                              marker.setMap(map);
                              marker.setPosition(results[0].geometry.location);
                            } else {
                              alert("Geocode was not successful for the following reason: " + status);
                            }
                          });

                    });
				}
			});
		}
		function initialiseMap() {
			$("#map_canvas").height($("#all-calls").height());
			var mapOptions = {
				center : new google.maps.LatLng(50, 0),
				zoom : 5,
				mapTypeId : google.maps.MapTypeId.ROADMAP
			};
			map = new google.maps.Map(document.getElementById("map_canvas"),
					mapOptions);
		}
		$(document).ready(function() {
			var queue = $.Deferred();
			queue.resolve();
			$.each([ "call", "page", "nav" ], function(idx, resource) {
				queue = queue.then(function() {
					loadDustResource(resource)
				});
			});
			queue = queue.then(loadCalls);
			queue = queue.then(initialiseMap);
		});
	</script>
</body>
</html>